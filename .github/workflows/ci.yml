name: CI - Build and Test

on:
    pull_request:
        branches: ["redesign", "master"]
    push:
        branches: ["redesign"]
        paths-ignore:
            - "README.md"
            - "LICENSE"
            - ".gitignore"

jobs:
    build-test:
        runs-on: ubuntu-latest
        env:
            HUGO_VERSION: 0.139.4
            HUGO_CACHEDIR: /tmp/hugo_cache
        steps:
            - name: Checkout
              uses: actions/checkout@v6
              with:
                  submodules: recursive
                  fetch-depth: 0

            - name: Setup Hugo
              uses: peaceiris/actions-hugo@v3
              with:
                  hugo-version: "0.139.4"
                  extended: true

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Build site (development)
              env:
                  HUGO_ENVIRONMENT: development
              run: |
                  hugo \
                    --buildDrafts \
                    --buildFuture \
                    --gc

            - name: Build site (production)
              env:
                  HUGO_ENVIRONMENT: production
                  HUGO_ENV: production
              run: |
                  hugo \
                    --gc \
                    --minify

            - name: Check for build artifacts
              run: |
                  if [ ! -d "public" ]; then
                    echo "Error: public directory not found"
                    exit 1
                  fi
                  if [ ! -f "public/index.html" ]; then
                    echo "Error: index.html not found"
                    exit 1
                  fi
                  echo "âœ… Build artifacts verified"

            - name: Display build stats
              run: |
                  echo "ðŸ“Š Build Statistics:"
                  echo "Total files: $(find public -type f | wc -l)"
                  echo "HTML files: $(find public -name '*.html' | wc -l)"
                  echo "CSS files: $(find public -name '*.css' | wc -l)"
                  echo "JS files: $(find public -name '*.js' | wc -l)"
                  echo "Image files: $(find public \( -name '*.jpg' -o -name '*.png' -o -name '*.webp' -o -name '*.svg' \) | wc -l)"
                  du -sh public/ || true

    markdown-lint:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v6

            - name: Lint Markdown files
              uses: actionshub/markdownlint@main
              continue-on-error: true
              with:
                  path: content

    link-check:
        runs-on: ubuntu-latest
        needs: build-test
        steps:
            - name: Checkout
              uses: actions/checkout@v6

            - name: Setup Hugo
              uses: peaceiris/actions-hugo@v3
              with:
                  hugo-version: "0.139.4"
                  extended: true

            - name: Build site
              run: hugo --minify

            - name: Check internal links
              uses: lycheeverse/lychee-action@v2
              with:
                  args: --verbose --no-progress './public/**/*.html' --base './public'
              continue-on-error: true
