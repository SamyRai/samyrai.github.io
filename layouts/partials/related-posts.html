{{- /*
  Related posts section
  Manually filters posts by current language and excludes current page
  Note: .Site.RegularPages.Related . was returning cross-language results
*/ -}}

{{ $current := . }}
{{ $currentLang := .Language.Lang }}
{{ $related := slice }}
{{ range .Site.AllPages }}
  {{ if and (eq .Language.Lang $currentLang) (ne .RelPermalink $current.RelPermalink) (eq .Type "posts") }}
    {{ $related = $related | append . }}
    {{ if ge (len $related) 3 }}{{ break }}{{ end }}
  {{ end }}
{{ end }}
{{ with $related }}
<aside class="related-posts">
  <h3 class="related-title">{{ i18n "related_posts" }}</h3>
  <div class="related-grid">
    {{ range . }}
      <article class="related-card">
        {{ with .Resources.GetMatch "featured.*" }}
          {{ $thumb := .Fill "400x250 webp q85" }}
          <div class="related-image">
            <img src="{{ $thumb.RelPermalink }}" alt="{{ $.Title }}" loading="lazy">
          </div>
        {{ else }}
          <div class="related-image related-image-placeholder">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
          </div>
        {{ end }}

        <div class="related-content">
          <h4 class="related-card-title">
            <a href="{{ .RelPermalink }}">{{ .Title }}</a>
          </h4>

          <div class="related-meta">
            <time datetime="{{ .Date.Format "2006-01-02" }}">
              {{ .Date.Format "Jan 2, 2006" }}
            </time>
            {{ if .ReadingTime }}
              <span class="reading-time">
                {{ i18n "reading_time" . }}
              </span>
            {{ end }}
          </div>

          {{ with .Summary }}
            <p class="related-summary">{{ . | truncate 120 }}</p>
          {{ end }}
        </div>
      </article>
    {{ end }}
  </div>
</aside>

<style>
.related-posts {
  margin-top: 4rem;
  padding-top: 3rem;
  border-top: 2px solid #e5e7eb;
}

.related-title {
  font-size: 1.5rem;
  font-weight: 700;
  color: #111827;
  margin: 0 0 2rem 0;
}

.related-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 2rem;
}

.related-card {
  background: white;
  border-radius: 0.5rem;
  overflow: hidden;
  border: 1px solid #e5e7eb;
  transition: transform 0.2s, box-shadow 0.2s;
}

.related-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
}

.related-image {
  aspect-ratio: 16/9;
  overflow: hidden;
  background: #f3f4f6;
}

.related-image img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: transform 0.3s;
}

.related-card:hover .related-image img {
  transform: scale(1.05);
}

.related-image-placeholder {
  display: flex;
  align-items: center;
  justify-content: center;
  color: #d1d5db;
}

.related-image-placeholder svg {
  width: 4rem;
  height: 4rem;
}

.related-content {
  padding: 1.5rem;
}

.related-card-title {
  margin: 0 0 0.75rem 0;
  font-size: 1.125rem;
  font-weight: 600;
  line-height: 1.4;
}

.related-card-title a {
  color: #111827;
  text-decoration: none;
  transition: color 0.2s;
}

.related-card-title a:hover {
  color: var(--primary-color, #3b82f6);
}

.related-meta {
  display: flex;
  align-items: center;
  gap: 1rem;
  font-size: 0.875rem;
  color: #6b7280;
  margin-bottom: 0.75rem;
}

.related-meta time {
  display: flex;
  align-items: center;
}

.reading-time::before {
  content: "â€¢";
  margin-right: 0.5rem;
}

.related-summary {
  font-size: 0.875rem;
  color: #6b7280;
  line-height: 1.6;
  margin: 0;
}

@media (max-width: 768px) {
  .related-grid {
    grid-template-columns: 1fr;
  }
}
</style>
{{ end }}
